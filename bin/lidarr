#!/usr/bin/env node

'use strict';

const lidarr = require('..');

const bunyan = require('bunyan');
const bunyanDebugStream = require('bunyan-debug-stream');
const fse = require('fs-extra');
const path = require('path');

(async () => {
const logger = bunyan.createLogger({
	name: 'lidarr',
	streams: [{
        level: 'info',
        type: 'raw',
        stream: bunyanDebugStream({
            basepath: path.resolve(path.join(__dirname, '..')),
            forceColor: true
        })
	}],
	serializers: bunyanDebugStream.serializers
});

const configPath = path.join(process.cwd(), 'config.json');
let config = fse.readJsonSync(configPath, { throws: false });

if (!config) {
	logger.error({ config: configPath }, 'Missing config file');
	//process.exit();
}

config = Object.assign({
	data: path.join(process.cwd(), 'data'),
	library: null,
	import: []
}, config);

	let dbFile = path.join(config.data, 'db.sqlite')
	await fse.ensureDir(config.data);
	console.log("db file", dbFile);
	logger.debug({db: dbFile}, "Using database file")
	let db = await lidarr.db(dbFile);//, console.log);//logger.info.bind(logger));
	let dbNeedsMigration = await db.migrator.pending();

	if (dbNeedsMigration) {
		logger.info("Upgrading database");
		await db.migrator.up();
	}

	if (config.library) {
		logger.info("Syncing library");
		await lidarr.sync.dir(config.library, db);
		logger.info("Done syncing library");
	}

	logger.info('Starting up')

	const server = new lidarr.Server(db, logger);
	await server.start(8080);
	logger.info('Server started');
})();
