#!/usr/bin/env node

'use strict';

const lidarr = require('..');

const bunyan = require('bunyan');
const bunyanDebugStream = require('bunyan-debug-stream');
const fse = require('fs-extra');
const path = require('path');

(async () => {
	const env = await lidarr.Environment.load({
		file: path.join(process.cwd(), 'config.json')
	});

	env.logger.info("Starting app");

	let dbNeedsMigration = await env.db.migrator.pending();

	if (dbNeedsMigration.length) {
		env.logger.info("Upgrading database");
		await env.db.migrator.up();
	}

	if (env.config.paths.library) {
		env.logger.info("Syncing library");
		await (new lidarr.task.SyncTask(env.config.paths.library, env)).run();
		env.logger.info("Done syncing library");
	}

	env.logger.info("Generating thumbnails");
	await (new lidarr.task.ThumbnailTask(env)).run();

	env.logger.info('Starting up')

	const server = new lidarr.Server(env.db, env.logger, env);
	await server.start(8080);
	env.logger.info('Server started');
})();
